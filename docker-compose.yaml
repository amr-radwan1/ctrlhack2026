services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      FRONTEND_ORIGIN: ${FRONTEND_ORIGIN:-http://localhost:3000}
      MONGODB_URI: ${MONGODB_URI:?MONGODB_URI is required}
      MONGODB_DB_NAME: ${MONGODB_DB_NAME:?MONGODB_DB_NAME is required}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-1440}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      MONGODB_ENSURE_INDEXES: ${MONGODB_ENSURE_INDEXES:-true}
      MONGODB_CONNECT_RETRIES: ${MONGODB_CONNECT_RETRIES:-3}
      MONGODB_CONNECT_RETRY_DELAY_SECONDS: ${MONGODB_CONNECT_RETRY_DELAY_SECONDS:-3}
    restart: unless-stopped
    expose:
      - "8000"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_FASTAPI_BASE_URL: ${NEXT_PUBLIC_FASTAPI_BASE_URL:-/api}
        BACKEND_INTERNAL_URL: ${BACKEND_INTERNAL_URL:-http://backend:8000}
    environment:
      NEXT_PUBLIC_FASTAPI_BASE_URL: ${NEXT_PUBLIC_FASTAPI_BASE_URL:-/api}
      BACKEND_INTERNAL_URL: ${BACKEND_INTERNAL_URL:-http://backend:8000}
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    expose:
      - "80"
